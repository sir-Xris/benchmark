#!/usr/bin/env bash

# To test src and std
run () {
    echo -n "Running $1... "
    INFO=$(env time -f '%E %M' 2>&1 exe/$1 < data/input > data/$1)
    read TIME MEMORY <<< $INFO
    # Convert Memory(KB) to Memory(MB)
    MEMORY=$(echo "scale=2;$MEMORY/1024" | bc 2> /dev/null)
    echo ${TIME}s ${MEMORY}MB
}

trap 'exit 0' INT
# Stop running if compile failed
trap 'exit 1' ERR

# Compile, if you want to change language, edit these 3 lines
g++ -O3 -Wall -o exe/mk mk.cc
g++ -O2 -Wall -o exe/std std.cc
g++ -O2 -Wall -o exe/src src.cc

# Program will not stop unless received an ERR or INT
echo -e "\033[1;35mWarning:\033[0m Press Ctrl+C to interrupt me."

# Wait for one second to take a look at warning
sleep 1

while [[ $? == 0 ]]; do
    echo -e '\nProducing data...'

    # Stop running if caught an ERR
    trap "echo -e '\033[1;31mRuntime Error\033[0m'; exit 1" ERR
    exe/mk > data/input
    run std
    run src

    # Ignore ERR caused by diff and handle it myself
    trap ERR
    diff -q data/std data/src
done

# Only if outputs of 2 program differ
# will the program come to here
g++ -g -o exe/src src.cc
